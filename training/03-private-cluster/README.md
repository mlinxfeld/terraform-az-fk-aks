# Lesson 3 â€” Private AKS Cluster (Secure Private API + Bastion Access)

In this example, we deploy an **Azure Kubernetes Service (AKS) private cluster** â€” a cluster whose API server is reachable **only inside the Virtual Network**.  
We combine:

- a private AKS control plane,
- Azure Bastion (Standard) with tunneling,
- a small jump VM in the private subnet,
- NAT Gateway for outbound connectivity (`userDefinedRouting` mode).

This setup ensures that **no public endpoint is exposed**, and all Kubernetes management happens strictly within the trusted network boundary.

---

## ğŸ“ Training Folder Structure

```
03-private-cluster/
â”œâ”€â”€ main.tf
â”œâ”€â”€ network.tf
â”œâ”€â”€ bastion.tf
â”œâ”€â”€ security.tf
â”œâ”€â”€ variables.tf
â”œâ”€â”€ outputs.tf
â””â”€â”€ README.md   â† (this file)
```

---

## ğŸš€ Deployment

Initialize and apply:

```bash
tofu init
tofu plan
tofu apply
```

A successful deployment looks like this:

```
azurerm_bastion_host.foggykitchen_bastion: Creation complete after 8m6s [id=/subscriptions/.../resourceGroups/fk-aks-demo-rg/providers/Microsoft.Network/bastionHosts/foggykitchen_bastion]

Apply complete! Resources: 18 added, 0 changed, 0 destroyed.

Outputs:

jump_private_key_openssh = <sensitive>

jump_public_key_openssh = ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQ...
```

> Tip: AKS private clusters need a **route table association** on the node pool subnet when `outbound_type = "userDefinedRouting"`. A blank UDR is sufficient â€” AKS only validates its presence.

---

## ğŸ” Retrieving SSH Key From Terraform Outputs

Extract the private SSH key generated by Terraform:

```bash
tofu output -raw jump_private_key_openssh > ~/.ssh/fk_jumpvm
chmod 600 ~/.ssh/fk_jumpvm
```

---

## ğŸ›° Connect to the Jump VM via Azure Bastion Tunneling

Open the tunnel (leave running):

```bash
az network bastion tunnel   --name foggykitchen_bastion   --resource-group fk-aks-demo-rg   --target-resource-id $(az vm show     -g fk-aks-demo-rg     -n foggykitchen_jump_vm     --query id -o tsv)   --resource-port 22   --port 50022
```

In a second terminal:

```bash
ssh -i ~/.ssh/fk_jumpvm -p 50022 azureuser@127.0.0.1
```

You should land in:

```
Welcome to Ubuntu 20.04.6 LTS
IPv4 address for eth0: 10.0.1.4
```

---

## ğŸ›  Installing Azure CLI & `kubectl` on the Jump Host

```bash
# Azure CLI
curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

# kubectl (stable)
curl -LO "https://dl.k8s.io/release/$(curl -Ls https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
sudo install -m 0755 kubectl /usr/local/bin/kubectl
```

Log in from the jump VM:

```bash
az login
az account set --subscription <SUB_ID>
```

---

## ğŸ”— Retrieve Private AKS Credentials

```bash
az aks get-credentials   -g fk-aks-demo-rg   -n fk-aks-private   --admin   --overwrite-existing
```

Verify cluster access:

```bash
kubectl cluster-info
kubectl get nodes -o wide
```

Expected output:

```
Kubernetes control plane is running at https://fk-aks-private-....privatelink.westeurope.azmk8s.io:443

NAME                             STATUS   ROLES    AGE   VERSION
aks-system-30550442-vmss000000   Ready    <none>   10m   v1.31.10
aks-system-30550442-vmss000001   Ready    <none>   10m   v1.31.10
```

---

## ğŸ§ª Smoke Test

```bash
kubectl create ns smoke
kubectl -n smoke create deployment whoami --image=containous/whoami --replicas=1
kubectl -n smoke get pods -o wide
```

Verify NAT Gateway egress:

```bash
curl -s ifconfig.me
```

You should see the public IP assigned to your NAT Gateway.

---

## âš ï¸ Troubleshooting

### Issue: `ExistingRouteTableNotAssociatedWithSubnet`
**Reason:** AKS private cluster with `outbound_type=userDefinedRouting` requires a UDR on the node pool subnet.

âœ… Solution: create a blank route table and associate it. No routes required.

---

### Issue: SSH `Permission denied (publickey)`
- Use the key generated by Terraform (`jump_private_key_openssh`).
- Confirm file permissions: `chmod 600`.

---

### Issue: Bastion tunnel says `Defined port is currently unavailable`
Try another local port, e.g.:

```bash
--port 40022
```

## âœ… Summary

This example demonstrates:

- How to deploy an **AKS private cluster** using Terraform.
- How to access the private API server securely using **Azure Bastion tunneling**.
- How to run `kubectl` exclusively from within the Virtual Network.

This setup mirrors the architecture of a **private OKE cluster** on OCI, adapted to Azureâ€™s AKS model.

---

## ğŸŒ Learn More

Visit **[FoggyKitchen.com](https://foggykitchen.com/)** for multicloud Terraform examples, workshops, and in-depth training.

---

## ğŸªª License

Licensed under the **Universal Permissive License (UPL), Version 1.0**.  
See [LICENSE](../../LICENSE) for details.